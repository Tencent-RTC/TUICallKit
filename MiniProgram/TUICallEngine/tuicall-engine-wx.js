import{TRTC as t,TIM as e,TSignaling as i}from"./libSrcConfig";class a{on(t,e,i){"function"==typeof e?(this._stores=this._stores||{},(this._stores[t]=this._stores[t]||[]).push({cb:e,ctx:i})):console.error("listener must be a function")}emit(t){this._stores=this._stores||{};let e,i=this._stores[t];if(i){i=i.slice(0),e=[].slice.call(arguments,1),e[0]={eventCode:t,data:e[0]};for(let t=0,a=i.length;t<a;t++)i[t].cb.apply(i[t].ctx,e)}}off(t,e){if(this._stores=this._stores||{},!arguments.length)return void(this._stores={});const i=this._stores[t];if(!i)return;if(1===arguments.length)return void delete this._stores[t];let a;for(let t=0,s=i.length;t<s;t++)if(a=i[t].cb,a===e){i.splice(t,1);break}}}const s={INVITED:"INVITED",GROUP_CALL_INVITEE_LIST_UPDATE:"GROUP_CALL_INVITEE_LIST_UPDATE",USER_ENTER:"USER_ENTER",USER_LEAVE:"USER_LEAVE",USER_ACCEPT:"USER_ACCEPT",USER_UPDATE:"USER_UPDATE",REJECT:"REJECT",NO_RESP:"NO_RESP",LINE_BUSY:"LINE_BUSY",CALLING_CANCEL:"CALLING_CANCEL",CALLING_TIMEOUT:"CALLING_TIMEOUT",CALL_END:"CALL_END",USER_VIDEO_AVAILABLE:"USER_VIDEO_AVAILABLE",USER_AUDIO_AVAILABLE:"USER_AUDIO_AVAILABLE",USER_VOICE_VOLUME:"USER_VOICE_VOLUME",SDK_READY:"SDK_READY",KICKED_OUT:"KICKED_OUT",CALL_MODE:"CALL_MODE",HANG_UP:"HANG_UP",ERROR:"ERROR"},n={IDLE:"idle",CALLING:"calling",CONNECTED:"connected"},r=1,o=2,l=3,c=4,h=5,u=1,d={AUDIO:1,VIDEO:2},p=["","audioCall","videoCall"],g="audio",f="video",E={EAR:"ear",SPEAKER:"speaker"},m={BASE:Math.pow(2,16),PRO:Math.pow(2,17),ULTIMATE:Math.pow(2,18)},I=-1002,T=-1003,y=-1101,D=-1201,v=-1202,_=-1203,C='The package you purchased does not support this ability. You can refer to "Service Activation" to purchase: https://buy.cloud.tencent.com/avc',S="TIM  SDK version is too old, Please upgrade version >= 2.20.1",R="camera or microphone not authorized",A="init is not called, the TUICallEngine API needs to be used after init";class L{constructor(t){this.TSignaling=t.TSignaling}handleNewSignaling(t,e){return{extraInfo:"",...t,version:4,businessID:"av_call",platform:"MiniApp",data:{cmd:p[t.call_type],room_id:t.room_id,message:"",...e}}}extractCallingInfoFromMessage(t){if(!t||"TIMCustomElem"!==t.type)return"";const e=JSON.parse(t.payload.data);if(e.businessID!==u)return"";switch(e.actionType){case r:{const t=JSON.parse(e.data);return t.call_end>0&&!e.groupID?t.call_end:0!==t.call_end&&t.room_id?"发起通话":"结束群聊"}case o:return"取消通话";case l:return"已接听";case c:return"拒绝通话";case h:return"无应答";default:return""}}handleError(t,e){return console.error(`TSignalingClint ${e}`,t),t}_handleInviteData(t){const{type:e,roomID:i,userIDList:a,hangup:s,switchMode:n}=t;if(s)return JSON.stringify(this.handleNewSignaling({version:0,call_type:e,call_end:s.callEnd},{cmd:"hangup"}));if(n){const t={version:0,call_type:e,room_id:i},a={cmd:"switchToVideo"};return n===g&&(t.switch_to_audio_call="switch_to_audio_call",a.cmd="switchToAudio"),JSON.stringify(this.handleNewSignaling(t,a))}return JSON.stringify(this.handleNewSignaling({version:0,call_type:e,room_id:i},{userIDs:a}))}_handleInviteGroupData(t){const{type:e,roomID:i,hangup:a}=t;let s=null;return s=a?JSON.stringify(this.handleNewSignaling({version:0,call_type:e,call_end:a.call_end},{cmd:"hangup"})):JSON.stringify(this.handleNewSignaling({version:0,call_type:e,room_id:i})),s}async _inviteInGroupTRTC(t){const{userIDList:e,roomID:i,type:a,timeout:s,offlinePushInfo:n}=t,r={code:0,data:[]};try{const t=e.map((t=>this.invite({userID:t,type:a,roomID:i,timeout:s,offlinePushInfo:n,userIDList:e}))),o=await Promise.all(t);r.data=o}catch(t){r.code=1,r.error=t,this.handleError(t,"inviteGroup TRTC")}return r}async invite(t){const{userID:e,offlinePushInfo:i,hangup:a,switchMode:s}=t;try{return await this.TSignaling.invite({userID:e,data:this._handleInviteData(t),timeout:a?0:30,offlinePushInfo:i})}catch(t){return a?this.handleError(t,"hangup C2C"):s?this.handleError(t,s):this.handleError(t,"invite")}}async inviteGroup(t){const{groupID:e,userIDList:i,offlinePushInfo:a,hangup:s}=t;if(!e)return await this._inviteInGroupTRTC(t);try{return await this.TSignaling.inviteInGroup({groupID:e,inviteeList:i,timeout:s?0:30,data:this._handleInviteGroupData(t),offlinePushInfo:a})}catch(t){return s?this.handleError(t,"hangup group"):this.handleError(t,"inviteGroup")}}async accept(t,e){const{inviteID:i,type:a,...s}=t;try{return await this.TSignaling.accept({inviteID:i,data:JSON.stringify(this.handleNewSignaling({version:0,call_type:a,...s},e))})}catch(t){return this.handleError(t,"accept")}}async reject(t){const{inviteID:e,type:i,lineBusy:a}=t,s={version:0,call_type:i};let n=null;a?(s.line_busy=a,n=JSON.stringify(this.handleNewSignaling(s,{message:"lineBusy"}))):n=JSON.stringify(this.handleNewSignaling(s));try{return await this.TSignaling.reject({inviteID:e,data:n})}catch(t){return a?this.handleError(t,"line_busy"):this.handleError(t,"reject")}}async cancel(t){const{inviteIDList:e,callType:i}=t,a=[];try{for(let t=0;t<e.length;t++){const s=e[t],n=await this.TSignaling.cancel({inviteID:s,data:JSON.stringify(this.handleNewSignaling({version:0,call_type:i}))});a.push(n)}return a}catch(t){return this.handleError(t,"cancel")}}async lastOneHangup(t){const{userIDList:e,callType:i,callEnd:a,groupID:s,isGroup:n}=t;return n?await this.inviteGroup({groupID:s,userIDList:e,type:i,hangup:{call_end:s?0:a}}):await this.invite({userID:e[0],type:i,hangup:{callEnd:a}})}async switchCallMode(t){const{userID:e,callType:i,roomID:a,mode:s}=t;return this.invite({userID:e,type:i,roomID:a,switchMode:s})}destroyed(){this.TSignaling=null}}class w{constructor(t){this._emitter=t.emitter}onCallEnd(t){const{userID:e,callEnd:i,message:a}=t;this._emitter.emit(s.CALL_END,{userID:e,callEnd:i,message:a})}onInvited(t){const{sponsor:e,inviteeList:i,isFromGroup:a,inviteData:n,inviteID:r}=t;this._emitter.emit(s.INVITED,{sponsor:e,inviteeList:i,isFromGroup:a,inviteID:r,inviteData:n})}onLineBusy(t){const{inviteID:e,invitee:i}=t;this._emitter.emit(s.LINE_BUSY,{inviteID:e,invitee:i,reason:"line busy"})}onReject(t){const{inviteID:e,invitee:i}=t;this._emitter.emit(s.REJECT,{inviteID:e,invitee:i,reason:"reject"})}onNoResp(t){const{groupID:e="",inviteID:i,sponsor:a,timeoutUserList:n}=t;this._emitter.emit(s.NO_RESP,{groupID:e,inviteID:i,sponsor:a,timeoutUserList:n})}onCancel(t){const{inviteID:e,invitee:i}=t;this._emitter.emit(s.CALLING_CANCEL,{inviteID:e,invitee:i})}onTimeout(t){const{inviteID:e,groupID:i,sponsor:a,timeoutUserList:n}=t;this._emitter.emit(s.CALLING_TIMEOUT,{groupID:i,inviteID:e,sponsor:a,timeoutUserList:n})}onUserAccept(t,e){this._emitter.emit(s.USER_ACCEPT,{userID:t,userList:e})}onUserEnter(t,e){this._emitter.emit(s.USER_ENTER,{userID:t,playerList:e})}onUserLeave(t,e){this._emitter.emit(s.USER_LEAVE,{userID:t,playerList:e})}onUserUpdate(t){const{pusher:e,playerList:i}=t;this._emitter.emit(s.USER_UPDATE,{pusher:e,playerList:i})}onSdkReady(t){this._emitter.emit(s.SDK_READY,t)}onKickedOut(t){this._emitter.emit(s.KICKED_OUT,t)}onCallMode(t){this._emitter.emit(s.CALL_MODE,t)}destroyed(){this._emitter=null}}const N="1.0.0";var O="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},b={exports:{}};(function(t,e,i){var a=function(t,e,i){i=s.extend({},s.options,i);var n=s.runValidations(t,e,i);if(n.some((function(t){return s.isPromise(t.error)})))throw new Error("Use validate.async if you want support for promises");return a.processValidationResults(n,i)},s=a;s.extend=function(t){return[].slice.call(arguments,1).forEach((function(e){for(var i in e)t[i]=e[i]})),t},s.extend(a,{version:{major:0,minor:13,patch:1,metadata:null,toString:function(){var t=s.format("%{major}.%{minor}.%{patch}",s.version);return s.isEmpty(s.version.metadata)||(t+="+"+s.version.metadata),t}},Promise:"undefined"!=typeof Promise?Promise:null,EMPTY_STRING_REGEXP:/^\s*$/,runValidations:function(t,e,i){var a,n,r,o,l,c,h,u=[];for(a in(s.isDomElement(t)||s.isJqueryElement(t))&&(t=s.collectFormValues(t)),e)for(n in r=s.getDeepObjectValue(t,a),o=s.result(e[a],r,t,a,i,e)){if(!(l=s.validators[n]))throw h=s.format("Unknown validator %{name}",{name:n}),new Error(h);c=o[n],(c=s.result(c,r,t,a,i,e))&&u.push({attribute:a,value:r,validator:n,globalOptions:i,attributes:t,options:c,error:l.call(l,r,c,a,t,i)})}return u},processValidationResults:function(t,e){t=s.pruneEmptyErrors(t,e),t=s.expandMultipleErrors(t,e),t=s.convertErrorMessages(t,e);var i=e.format||"grouped";if("function"!=typeof s.formatters[i])throw new Error(s.format("Unknown format %{format}",e));return t=s.formatters[i](t),s.isEmpty(t)?void 0:t},async:function(t,e,i){var a=(i=s.extend({},s.async.options,i)).wrapErrors||function(t){return t};!1!==i.cleanAttributes&&(t=s.cleanAttributes(t,e));var n=s.runValidations(t,e,i);return new s.Promise((function(r,o){s.waitForResults(n).then((function(){var l=s.processValidationResults(n,i);l?o(new a(l,i,t,e)):r(t)}),(function(t){o(t)}))}))},single:function(t,e,i){return i=s.extend({},s.single.options,i,{format:"flat",fullMessages:!1}),s({single:t},{single:e},i)},waitForResults:function(t){return t.reduce((function(t,e){return s.isPromise(e.error)?t.then((function(){return e.error.then((function(t){e.error=t||null}))})):t}),new s.Promise((function(t){t()})))},result:function(t){var e=[].slice.call(arguments,1);return"function"==typeof t&&(t=t.apply(null,e)),t},isNumber:function(t){return"number"==typeof t&&!isNaN(t)},isFunction:function(t){return"function"==typeof t},isInteger:function(t){return s.isNumber(t)&&t%1==0},isBoolean:function(t){return"boolean"==typeof t},isObject:function(t){return t===Object(t)},isDate:function(t){return t instanceof Date},isDefined:function(t){return null!=t},isPromise:function(t){return!!t&&s.isFunction(t.then)},isJqueryElement:function(t){return t&&s.isString(t.jquery)},isDomElement:function(t){return!!t&&!(!t.querySelectorAll||!t.querySelector)&&(!(!s.isObject(document)||t!==document)||("object"==typeof HTMLElement?t instanceof HTMLElement:t&&"object"==typeof t&&null!==t&&1===t.nodeType&&"string"==typeof t.nodeName))},isEmpty:function(t){var e;if(!s.isDefined(t))return!0;if(s.isFunction(t))return!1;if(s.isString(t))return s.EMPTY_STRING_REGEXP.test(t);if(s.isArray(t))return 0===t.length;if(s.isDate(t))return!1;if(s.isObject(t)){for(e in t)return!1;return!0}return!1},format:s.extend((function(t,e){return s.isString(t)?t.replace(s.format.FORMAT_REGEXP,(function(t,i,a){return"%"===i?"%{"+a+"}":String(e[a])})):t}),{FORMAT_REGEXP:/(%?)%\{([^\}]+)\}/g}),prettify:function(t){return s.isNumber(t)?100*t%1==0?""+t:parseFloat(Math.round(100*t)/100).toFixed(2):s.isArray(t)?t.map((function(t){return s.prettify(t)})).join(", "):s.isObject(t)?s.isDefined(t.toString)?t.toString():JSON.stringify(t):(t=""+t).replace(/([^\s])\.([^\s])/g,"$1 $2").replace(/\\+/g,"").replace(/[_-]/g," ").replace(/([a-z])([A-Z])/g,(function(t,e,i){return e+" "+i.toLowerCase()})).toLowerCase()},stringifyValue:function(t,e){return(e&&e.prettify||s.prettify)(t)},isString:function(t){return"string"==typeof t},isArray:function(t){return"[object Array]"==={}.toString.call(t)},isHash:function(t){return s.isObject(t)&&!s.isArray(t)&&!s.isFunction(t)},contains:function(t,e){return!!s.isDefined(t)&&(s.isArray(t)?-1!==t.indexOf(e):e in t)},unique:function(t){return s.isArray(t)?t.filter((function(t,e,i){return i.indexOf(t)==e})):t},forEachKeyInKeypath:function(t,e,i){if(s.isString(e)){var a,n="",r=!1;for(a=0;a<e.length;++a)switch(e[a]){case".":r?(r=!1,n+="."):(t=i(t,n,!1),n="");break;case"\\":r?(r=!1,n+="\\"):r=!0;break;default:r=!1,n+=e[a]}return i(t,n,!0)}},getDeepObjectValue:function(t,e){if(s.isObject(t))return s.forEachKeyInKeypath(t,e,(function(t,e){if(s.isObject(t))return t[e]}))},collectFormValues:function(t,e){var i,a,n,r,o,l,c={};if(s.isJqueryElement(t)&&(t=t[0]),!t)return c;for(e=e||{},r=t.querySelectorAll("input[name], textarea[name]"),i=0;i<r.length;++i)if(n=r.item(i),!s.isDefined(n.getAttribute("data-ignored"))){var h=n.name.replace(/\./g,"\\\\.");l=s.sanitizeFormValue(n.value,e),"number"===n.type?l=l?+l:null:"checkbox"===n.type?n.attributes.value?n.checked||(l=c[h]||null):l=n.checked:"radio"===n.type&&(n.checked||(l=c[h]||null)),c[h]=l}for(r=t.querySelectorAll("select[name]"),i=0;i<r.length;++i)if(n=r.item(i),!s.isDefined(n.getAttribute("data-ignored"))){if(n.multiple)for(a in l=[],n.options)(o=n.options[a])&&o.selected&&l.push(s.sanitizeFormValue(o.value,e));else{var u=void 0!==n.options[n.selectedIndex]?n.options[n.selectedIndex].value:"";l=s.sanitizeFormValue(u,e)}c[n.name]=l}return c},sanitizeFormValue:function(t,e){return e.trim&&s.isString(t)&&(t=t.trim()),!1!==e.nullify&&""===t?null:t},capitalize:function(t){return s.isString(t)?t[0].toUpperCase()+t.slice(1):t},pruneEmptyErrors:function(t){return t.filter((function(t){return!s.isEmpty(t.error)}))},expandMultipleErrors:function(t){var e=[];return t.forEach((function(t){s.isArray(t.error)?t.error.forEach((function(i){e.push(s.extend({},t,{error:i}))})):e.push(t)})),e},convertErrorMessages:function(t,e){var i=[],a=(e=e||{}).prettify||s.prettify;return t.forEach((function(t){var n=s.result(t.error,t.value,t.attribute,t.options,t.attributes,t.globalOptions);return s.isString(n)?("^"===n[0]?n=n.slice(1):!1!==e.fullMessages&&(n=s.capitalize(a(t.attribute))+" "+n),n=n.replace(/\\\^/g,"^"),n=s.format(n,{value:s.stringifyValue(t.value,e)}),void i.push(s.extend({},t,{error:n}))):void i.push(t)})),i},groupErrorsByAttribute:function(t){var e={};return t.forEach((function(t){var i=e[t.attribute];i?i.push(t):e[t.attribute]=[t]})),e},flattenErrorsToArray:function(t){return t.map((function(t){return t.error})).filter((function(t,e,i){return i.indexOf(t)===e}))},cleanAttributes:function(t,e){function i(t,e,i){return s.isObject(t[e])?t[e]:t[e]=!!i||{}}return s.isObject(e)&&s.isObject(t)?(e=function(t){var e,a={};for(e in t)t[e]&&s.forEachKeyInKeypath(a,e,i);return a}(e),function t(e,i){if(!s.isObject(e))return e;var a,n,r=s.extend({},e);for(n in e)a=i[n],s.isObject(a)?r[n]=t(r[n],a):a||delete r[n];return r}(t,e)):{}},exposeModule:function(t,e,i,a,s){i?(a&&a.exports&&(i=a.exports=t),i.validate=t):(e.validate=t,t.isFunction(s)&&s.amd&&s([],(function(){return t})))},warn:function(t){"undefined"!=typeof console&&console.warn&&console.warn("[validate.js] "+t)},error:function(t){"undefined"!=typeof console&&console.error&&console.error("[validate.js] "+t)}}),a.validators={presence:function(t,e){if(!1!==(e=s.extend({},this.options,e)).allowEmpty?!s.isDefined(t):s.isEmpty(t))return e.message||this.message||"can't be blank"},length:function(t,e,i){if(s.isDefined(t)){var a,n=(e=s.extend({},this.options,e)).is,r=e.maximum,o=e.minimum,l=e.tokenizer||function(t){return t},c=[],h=(t=l(t)).length;return s.isNumber(h)?(s.isNumber(n)&&h!==n&&(a=e.wrongLength||this.wrongLength||"is the wrong length (should be %{count} characters)",c.push(s.format(a,{count:n}))),s.isNumber(o)&&h<o&&(a=e.tooShort||this.tooShort||"is too short (minimum is %{count} characters)",c.push(s.format(a,{count:o}))),s.isNumber(r)&&h>r&&(a=e.tooLong||this.tooLong||"is too long (maximum is %{count} characters)",c.push(s.format(a,{count:r}))),c.length>0?e.message||c:void 0):e.message||this.notValid||"has an incorrect length"}},numericality:function(t,e,i,a,n){if(s.isDefined(t)){var r,o,l=[],c={greaterThan:function(t,e){return t>e},greaterThanOrEqualTo:function(t,e){return t>=e},equalTo:function(t,e){return t===e},lessThan:function(t,e){return t<e},lessThanOrEqualTo:function(t,e){return t<=e},divisibleBy:function(t,e){return t%e==0}},h=(e=s.extend({},this.options,e)).prettify||n&&n.prettify||s.prettify;if(s.isString(t)&&e.strict){var u="^-?(0|[1-9]\\d*)";if(e.onlyInteger||(u+="(\\.\\d+)?"),u+="$",!new RegExp(u).test(t))return e.message||e.notValid||this.notValid||this.message||"must be a valid number"}if(!0!==e.noStrings&&s.isString(t)&&!s.isEmpty(t)&&(t=+t),!s.isNumber(t))return e.message||e.notValid||this.notValid||this.message||"is not a number";if(e.onlyInteger&&!s.isInteger(t))return e.message||e.notInteger||this.notInteger||this.message||"must be an integer";for(r in c)if(o=e[r],s.isNumber(o)&&!c[r](t,o)){var d="not"+s.capitalize(r),p=e[d]||this[d]||this.message||"must be %{type} %{count}";l.push(s.format(p,{count:o,type:h(r)}))}return e.odd&&t%2!=1&&l.push(e.notOdd||this.notOdd||this.message||"must be odd"),e.even&&t%2!=0&&l.push(e.notEven||this.notEven||this.message||"must be even"),l.length?e.message||l:void 0}},datetime:s.extend((function(t,e){if(!s.isFunction(this.parse)||!s.isFunction(this.format))throw new Error("Both the parse and format functions needs to be set to use the datetime/date validator");if(s.isDefined(t)){var i,a=[],n=(e=s.extend({},this.options,e)).earliest?this.parse(e.earliest,e):NaN,r=e.latest?this.parse(e.latest,e):NaN;return t=this.parse(t,e),isNaN(t)||e.dateOnly&&t%864e5!=0?(i=e.notValid||e.message||this.notValid||"must be a valid date",s.format(i,{value:arguments[0]})):(!isNaN(n)&&t<n&&(i=e.tooEarly||e.message||this.tooEarly||"must be no earlier than %{date}",i=s.format(i,{value:this.format(t,e),date:this.format(n,e)}),a.push(i)),!isNaN(r)&&t>r&&(i=e.tooLate||e.message||this.tooLate||"must be no later than %{date}",i=s.format(i,{date:this.format(r,e),value:this.format(t,e)}),a.push(i)),a.length?s.unique(a):void 0)}}),{parse:null,format:null}),date:function(t,e){return e=s.extend({},e,{dateOnly:!0}),s.validators.datetime.call(s.validators.datetime,t,e)},format:function(t,e){(s.isString(e)||e instanceof RegExp)&&(e={pattern:e});var i,a=(e=s.extend({},this.options,e)).message||this.message||"is invalid",n=e.pattern;if(s.isDefined(t))return s.isString(t)?(s.isString(n)&&(n=new RegExp(e.pattern,e.flags)),(i=n.exec(t))&&i[0].length==t.length?void 0:a):a},inclusion:function(t,e){if(s.isDefined(t)&&(s.isArray(e)&&(e={within:e}),e=s.extend({},this.options,e),!s.contains(e.within,t))){var i=e.message||this.message||"^%{value} is not included in the list";return s.format(i,{value:t})}},exclusion:function(t,e){if(s.isDefined(t)&&(s.isArray(e)&&(e={within:e}),e=s.extend({},this.options,e),s.contains(e.within,t))){var i=e.message||this.message||"^%{value} is restricted";return s.isString(e.within[t])&&(t=e.within[t]),s.format(i,{value:t})}},email:s.extend((function(t,e){var i=(e=s.extend({},this.options,e)).message||this.message||"is not a valid email";if(s.isDefined(t))return s.isString(t)&&this.PATTERN.exec(t)?void 0:i}),{PATTERN:/^(?:[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*|"(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21\x23-\x5b\x5d-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])*")@(?:(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?|\[(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?|[a-z0-9-]*[a-z0-9]:(?:[\x01-\x08\x0b\x0c\x0e-\x1f\x21-\x5a\x53-\x7f]|\\[\x01-\x09\x0b\x0c\x0e-\x7f])+)\])$/i}),equality:function(t,e,i,a,n){if(s.isDefined(t)){s.isString(e)&&(e={attribute:e});var r=(e=s.extend({},this.options,e)).message||this.message||"is not equal to %{attribute}";if(s.isEmpty(e.attribute)||!s.isString(e.attribute))throw new Error("The attribute must be a non empty string");var o=s.getDeepObjectValue(a,e.attribute),l=e.comparator||function(t,e){return t===e},c=e.prettify||n&&n.prettify||s.prettify;return l(t,o,e,i,a)?void 0:s.format(r,{attribute:c(e.attribute)})}},url:function(t,e){if(s.isDefined(t)){var i=(e=s.extend({},this.options,e)).message||this.message||"is not a valid url",a=e.schemes||this.schemes||["http","https"],n=e.allowLocal||this.allowLocal||!1,r=e.allowDataUrl||this.allowDataUrl||!1;if(!s.isString(t))return i;var o="^(?:(?:"+a.join("|")+")://)(?:\\S+(?::\\S*)?@)?(?:",l="(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))";return n?l+="?":o+="(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})",o+="(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*"+l+")(?::\\d{2,5})?(?:[/?#]\\S*)?$",r&&(o="(?:"+o+")|(?:^data:(?:\\w+\\/[-+.\\w]+(?:;[\\w=]+)*)?(?:;base64)?,[A-Za-z0-9-_.!~\\*'();\\/?:@&=+$,%]*$)"),new RegExp(o,"i").exec(t)?void 0:i}},type:s.extend((function(t,e,i,a,n){if(s.isString(e)&&(e={type:e}),s.isDefined(t)){var r,o=s.extend({},this.options,e),l=o.type;if(!s.isDefined(l))throw new Error("No type was specified");if(r=s.isFunction(l)?l:this.types[l],!s.isFunction(r))throw new Error("validate.validators.type.types."+l+" must be a function.");if(!r(t,o,i,a,n)){var c=e.message||this.messages[l]||this.message||o.message||(s.isFunction(l)?"must be of the correct type":"must be of type %{type}");return s.isFunction(c)&&(c=c(t,e,i,a,n)),s.format(c,{attribute:s.prettify(i),type:l})}}}),{types:{object:function(t){return s.isObject(t)&&!s.isArray(t)},array:s.isArray,integer:s.isInteger,number:s.isNumber,string:s.isString,date:s.isDate,boolean:s.isBoolean},messages:{}})},a.formatters={detailed:function(t){return t},flat:s.flattenErrorsToArray,grouped:function(t){var e;for(e in t=s.groupErrorsByAttribute(t))t[e]=s.flattenErrorsToArray(t[e]);return t},constraint:function(t){var e;for(e in t=s.groupErrorsByAttribute(t))t[e]=t[e].map((function(t){return t.validator})).sort();return t}},a.exposeModule(a,this,t,e,i)}).call(O,b.exports,b,null);var U=b.exports;const V="number",M="string",x="object",P="function",$={createInstance:{sdkAppID:{presence:!0,type:V},tim:{type:x}},destroyInstance:{},init:{userID:{presence:!0,type:M},userSig:{presence:!0,type:M}},on:{eventCode:{presence:!0,type:M},handler:{presence:!0,type:P},context:{presence:!0,type:x}},off:{eventCode:{presence:!0,type:M},handler:{presence:!0,type:P}},call:{userID:{presence:!0,type:M},type:{presence:!0,type:V}},accept:{},reject:{},hangup:{},switchCallMediaType:{type:{presence:!0,type:V}},openCamera:{},closeCamera:{},switchCamera:{},openMicrophone:{},closeMicrophone:{},selectAudioPlaybackDevice:{type:{presence:!0,type:M}},setSelfInfo:{nickName:{presence:!0,type:M},avatar:{presence:!0,type:M}}},k={createInstance:"",destroyInstance:"",init:"",on:"",off:"",call:[n.IDLE],accept:[n.CALLING],reject:[n.CALLING],hangup:[n.CALLING,n.CONNECTED],switchCallMediaType:[n.CALLING,n.CONNECTED],openCamera:[n.CALLING,n.CONNECTED],closeCamera:[n.CALLING,n.CONNECTED],switchCamera:[n.CALLING,n.CONNECTED],openMicrophone:[n.CALLING,n.CONNECTED],closeMicrophone:[n.CALLING,n.CONNECTED],selectAudioPlaybackDevice:[n.CALLING,n.CONNECTED],setSelfInfo:""},H={createInstance:!1,destroyInstance:!0,init:!1,on:!1,off:!1,call:!0,accept:!0,reject:!0,hangup:!0,switchCallMediaType:!0,openCamera:!0,closeCamera:!0,switchCamera:!0,openMicrophone:!0,closeMicrophone:!0,selectAudioPlaybackDevice:!0,setSelfInfo:!0};class G extends Error{code;message;data;constructor(t,e,i){super(e),this.code=t,this.message=e,this.data=i}static error(t,e,i){return i?new G(t,e,i):new G(t,e)}}U.validators.type.types.function=function(t){return t instanceof Function};class j{paramsMatchedRule=$;statusMatchedRule=k;requireInit=H;getParamsMatchedRule(t){return this.paramsMatchedRule[t]}getStatusMatchedRule(t){return this.statusMatchedRule[t]}getInitReadyRule(t){return this.requireInit[t]}}class K{notify(t,e,i){throw G.error(e,`[TUICallEngine:${t.api},${e}]${i}`)}}class F{api="";attributes={};callStatus="";capabilityCode;checkDevicePermissions;initReady;constructor(t){this.api=t.api,this.attributes=t.attributes,this.callStatus=t.callStatus,this.capabilityCode=t.capabilityCode,this.checkDevicePermissions=t.checkDevicePermissions,this.initReady=t.initReady}}class z{#t;constructor(){this.#t=[]}addAlertHandler(t){this.#t.push(t)}async check(t,e){for(let i=0;i<this.#t.length;i++)await this.#t[i].check(t,e)}checkSync(t,e){for(let i=0;i<this.#t.length;i++)this.#t[i].check(t,e)}}class J{rule;notification;constructor(t,e){this.rule=t,this.notification=e}async check(t){}}class B extends J{constructor(t,e){super(t,e)}check(t){const e=this.rule.getParamsMatchedRule(t.api);if(e&&t.attributes){const i=U(t.attributes,e);if(void 0!==i)for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&this.notification.notify(t,v,i[e])}}}class q extends J{constructor(t,e){super(t,e)}check(t){if(t.callStatus){const e=this.rule.getStatusMatchedRule(t.api);e&&!e.includes(t.callStatus)&&this.notification.notify(t,_,`The current state is ${t.callStatus},cannot call this interface`)}}}class Y extends J{constructor(t,e){super(t,e)}async check(t,e={}){if(t.capabilityCode)try{!1===(await e.tim.callExperimentalAPI("isCommercialAbilityEnabled",t.capabilityCode)).data.enabled&&this.notification.notify(t,I,C)}catch(e){2905===e.code?this.notification.notify(t,T,S):this.notification.notify(t,I,C)}}}class X extends J{constructor(t,e){super(t,e)}async check(t,e){t.checkDevicePermissions&&(wx.authorize({scope:"scope.record"}),wx.authorize({scope:"scope.camera"}),await wx.getSetting().then((e=>{e.authSetting["scope.camera"]&&e.authSetting["scope.record"]||this.notification.notify(t,y,R)})))}}class W extends J{constructor(t,e){super(t,e)}check(t,e){void 0!==t.initReady&&this.rule.getInitReadyRule(t.api)!==t.initReady&&this.notification.notify(t,D,A)}}class Z{alertRule;notification;alert;static instance;initializeBeans(){this.alertRule=new j,this.notification=new K,this.alert=new z,this.alert.addAlertHandler(new B(this.alertRule,this.notification)),this.alert.addAlertHandler(new W(this.alertRule,this.notification)),this.alert.addAlertHandler(new Y(this.alertRule,this.notification)),this.alert.addAlertHandler(new X(this.alertRule,this.notification)),this.alert.addAlertHandler(new q(this.alertRule,this.notification))}getAlert(){return this.alert}static getInstance(){return this.instance||(this.instance=new Z,this.instance.initializeBeans()),this.instance}}const Q="TUICallEngine";class tt{static instance=null;static AUDIO_PLAYBACK_DEVICE=E;static MEDIA_TYPE=d;static EVENT=s;static STATUS=n;_initReady=!1;_timExternal=!1;constructor(n){this.data={config:{sdkAppID:n.sdkAppID,userID:"",userSig:"",type:1}},this.initData(),this.EVENT=s,this.MEDIA_TYPE=d,this.CALL_TYPE=d,this._emitter=new a,this.TRTC=new t(this,{TUIScene:"TUICalling"}),wx.TUIScene="TUICalling",n.tim?(this.tim=n.tim,this._timExternal=!0):this.tim=e.create({SDKAppID:n.sdkAppID}),wx.$TSignaling||(wx.$TSignaling=new i({SDKAppID:n.sdkAppID,tim:this.tim})),this.TSignalingClient=new L({TSignaling:wx.$TSignaling}),this.TRTCCallingDelegate=new w({emitter:this._emitter}),console.info(`${Q} SDK Version:${N}, SDKAppID:${n.sdkAppID}`)}static createInstance(t){return Z.getInstance().getAlert().checkSync(new F({api:"createInstance",attributes:t})),tt.instance||(tt.instance=new tt(t)),tt.instance.initData(),tt.instance}static destroyInstance(){Z.getInstance().getAlert().checkSync(new F({api:"destroyInstance",initReady:this.instance._initReady})),null!==tt.instance&&(tt.instance.destroyed(),tt.instance=null)}initData(){const t={callStatus:n.IDLE,soundMode:this.data.config.type===d.AUDIO?E.EAR:E.SPEAKER,active:!1,invitation:{inviteID:"",inviter:"",type:"",roomID:""},startTalkTime:0,localUser:null,remoteUsers:[],timer:null,chatTimeNum:0,chatTime:"00:00:00",screen:"pusher",pusher:{},playerList:[],roomID:"",groupInviteID:[],isSponsor:!0,_unHandledInviteeList:[],_connectUserIDList:[],_isGroupCall:!1,_groupID:"",_switchCallModeStatus:!0,enterRoomStatus:!1,isCallEnd:!0};this.data={...this.data,...t}}async handleSwitchCallModeTSignaling(t,e){const i={inviteID:t,type:e.call_type},a={cmd:"switchToVideo"};e.call_type===d.VIDEO&&(i.switch_to_audio_call="switch_to_audio_call",a.cmd="switchToAudio");const s=await this.TSignalingClient.accept(i,a);this.setSwitchCallModeStatus(!1),this.handleCallMode(e.call_type,s)}handleCallMode(t,e){console.log(`${Q}.handleCallMode - type`,t);const i=t!==d.VIDEO;this.setPusherAttributesHandler({enableCamera:i}),i?(this.data.config.type=d.VIDEO,this.data.invitation.type=d.VIDEO):(this.data.config.type=d.AUDIO,this.data.invitation.type=d.AUDIO),this.TRTCCallingDelegate.onCallMode({type:this.data.config.type,message:e.data.message}),this.setSwitchCallModeStatus(!0)}judgeSwitchCallMode(t){return t.switch_to_audio_call&&"switch_to_audio_call"===t.switch_to_audio_call||t.data&&"switchToAudio"===t.data.cmd||t.data&&"switchToVideo"===t.data.cmd}handleNewInvitationReceived(t){console.log(Q,"onNewInvitationReceived",`callStatus：${this.data.callStatus===n.CALLING||this.data.callStatus===n.CONNECTED}, inviteID:${t.data.inviteID} inviter:${t.data.inviter} inviteeList:${t.data.inviteeList} data:${t.data.data}`);const{data:{inviter:e,inviteeList:i,data:a,inviteID:s,groupID:r}}=t,o=JSON.parse(a),l=!!(r||i.length>=2||o.data&&o.data.userIDs&&o.data.userIDs.length>=2);if("hangup"===o?.data?.cmd)return void(this.data.callStatus===n.CONNECTED&&this.TRTCCallingDelegate.onCallEnd(e,o.call_end||0));let c=!1;if(l&&(!o.room_id||o.call_end&&0===o.call_end)&&(c=!0),!l&&o.call_end>=0&&(c=!0),c)return void this._reset(l?0:o.call_end);if(!this.data._isGroupCall&&this.judgeSwitchCallMode(o))return void(this.data.callStatus!==n.IDLE&&o.room_id===this.data.invitation.roomID&&this.handleSwitchCallModeTSignaling(s,o));if(this.data.callStatus===n.CALLING||this.data.callStatus===n.CONNECTED)return void this.TSignalingClient.reject({inviteID:s,type:a.call_type,lineBusy:"line_busy"});const h={_isGroupCall:!!l,_groupID:r||"",_unHandledInviteeList:[...i,e]};l&&!r&&(h._unHandledInviteeList=[...o.data.userIDs]),this.data.config.type=o.call_type,this.data.invitation.inviteID=s,this.data.invitation.inviter=e,this.data.invitation.type=o.call_type,this.data.invitation.roomID=o.room_id,this.data.isSponsor=!1,this.data._connectUserIDList=[e],this.data._isGroupCall=h._isGroupCall,this.data._groupID=h._groupID,this.data._unHandledInviteeList=h._unHandledInviteeList,this._getUserProfile([e]),this._setCallStatus(n.CALLING),console.log(`${Q} NEW_INVITATION_RECEIVED invitation: `,this.data.callStatus,this.data.invitation);const u={sponsor:e,inviteeList:i,isFromGroup:l,inviteID:s,inviteData:{version:o.version,callType:o.call_type,roomID:o.room_id,callEnd:0}};this.setPusherAttributesHandler({enableCamera:this.data.config.type===d.VIDEO}),wx.createLivePusherContext().startPreview(),this.TRTCCallingDelegate.onInvited(u)}setInviteIDList(t){if(this.data.invitation.inviteID===t||""===this.data.invitation.inviteID)return void(this.data.invitation.inviteID="");const e=[...this.data.groupInviteID];this.data.groupInviteID=e.filter((e=>e!==t))}async handleInviteeAccepted(t){console.log(`${Q} INVITEE_ACCEPTED inviteID:${t.data.inviteID} invitee:${t.data.invitee} data:`,t.data);const e=JSON.parse(t.data.data);this.data.callStatus!==n.IDLE?this.data._isGroupCall||!this.judgeSwitchCallMode(e)||this.data._switchCallModeStatus?(t.data.inviter===this._getUserID()&&this.data.callStatus===n.CALLING&&(this._setCallStatus(n.CONNECTED),this.TRTCCallingDelegate.onUserAccept(t.data.invitee,await this.getUserProfile(this.data._unHandledInviteeList.map((t=>({userID:t})))))),this.setInviteIDList(t.data.inviteID),this._getGroupCallFlag()&&this._setUnHandledInviteeList(t.data.invitee)):this.handleCallMode(this.data.invitation.type):this._reset()}handleInviteeRejected(t){if(console.log(`${Q} INVITEE_REJECTED inviteID:${t.data.inviteID} invitee:${t.data.invitee} data:${t.data.data}`),this.data._isGroupCall||this.data._switchCallModeStatus||(console.log(`${Q}.onInviteeRejected - Audio and video switching is not available`),this.setSwitchCallModeStatus(!0)),t.data.inviter!==this._getUserID())return;if(this.data.callStatus===n.CONNECTED){if(this.data.playerList.some((e=>e.userID===t.data.invitee)))return}this.setInviteIDList(t.data.inviteID);const e=JSON.parse(t.data.data),i=""===e.line_busy||"line_busy"===e.line_busy,a=e.data&&e.data.message&&"lineBusy"===e.data.message;this._getGroupCallFlag()?this._setUnHandledInviteeList(t.data.invitee,(t=>{if(0===t.length){const t=this.data.callStatus===n.CALLING,e=this.data.callStatus===n.CONNECTED&&0===this.data.playerList.length;(t||e)&&this._reset()}})):this._reset(0,i||a?"lineBusy":"reject")}handleInvitationCancelled(t){this.data.invitation.inviteID===t.data.inviteID&&(this.data.callStatus!==n.IDLE?(console.log(Q,"onInvitationCancelled",`inviteID:${t.data.inviteID} inviter:${t.data.invitee} data:${t.data.data}`),this._setCallStatus(n.IDLE),this.TRTCCallingDelegate.onCancel({inviteID:t.data.inviteID,invitee:t.data.invitee}),this.data.isCallEnd=!1,this.setInviteIDList(t.data.inviteID),this._reset()):this._reset())}handleInvitationTimeout(t){console.log(Q,"onInvitationTimeout",`data:${JSON.stringify(t)} inviteID:${t.data.inviteID} inviteeList:${t.data.inviteeList}`);const{groupID:e="",inviteID:i,inviter:a,inviteeList:s,isSelfTimeout:r}=t.data;if(this.data.invitation.inviteID===t.data.inviteID)if(this.data.callStatus!==n.IDLE){if(this.setInviteIDList(t.data.inviteID),r&&a===this._getUserID())return this.TRTCCallingDelegate.onNoResp({groupID:e,inviteID:i,sponsor:a,timeoutUserList:s}),void(this.data.callStatus!==n.CONNECTED&&(this.data.isCallEnd=!1,this._reset()));if(this.TRTCCallingDelegate.onTimeout({groupID:e,inviteID:i,sponsor:a,timeoutUserList:s}),this._getGroupCallFlag()){const t=this.data._unHandledInviteeList,e=[];if(t.forEach((t=>{-1===s.indexOf(t)&&e.push(t)})),this.data._unHandledInviteeList=e,0===e.length&&0===this.data.playerList.length){if(this.data.callStatus===n.CONNECTED)return void this.lastOneHangup({userIDList:[a],callType:this.data.config.type,callEnd:0});this.data.isCallEnd=!1,this._reset()}}else this.data.isCallEnd=!1,this._reset();s.includes(this._getUserID())&&this._setCallStatus(n.IDLE)}else this._reset()}handleSDKReady(){console.log(Q,"TSignaling SDK ready"),this.TSignalingResolve(),this.TRTCCallingDelegate.onSdkReady({message:"SDK ready"});this.tim.getMyProfile().then((t=>{this.data.localUser=t.data})).catch((t=>{console.warn("getMyProfile error:",t)}))}handleKickedOut(){this.hangup(),this.TRTCCallingDelegate.onKickedOut({message:"kicked out"})}_addTSignalingEvent(){wx.$TSignaling.on(i.EVENT.NEW_INVITATION_RECEIVED,this.handleNewInvitationReceived,this),wx.$TSignaling.on(i.EVENT.INVITEE_ACCEPTED,this.handleInviteeAccepted,this),wx.$TSignaling.on(i.EVENT.INVITEE_REJECTED,this.handleInviteeRejected,this),wx.$TSignaling.on(i.EVENT.INVITATION_CANCELLED,this.handleInvitationCancelled,this),wx.$TSignaling.on(i.EVENT.INVITATION_TIMEOUT,this.handleInvitationTimeout,this),wx.$TSignaling.on(i.EVENT.SDK_READY,this.handleSDKReady,this),wx.$TSignaling.on(i.EVENT.KICKED_OUT,this.handleKickedOut,this)}_removeTSignalingEvent(){wx.$TSignaling.off(i.EVENT.NEW_INVITATION_RECEIVED,this.handleNewInvitationReceived),wx.$TSignaling.off(i.EVENT.INVITEE_ACCEPTED,this.handleInviteeAccepted),wx.$TSignaling.off(i.EVENT.INVITEE_REJECTED,this.handleInviteeRejected),wx.$TSignaling.off(i.EVENT.INVITATION_CANCELLED,this.handleInvitationCancelled),wx.$TSignaling.off(i.EVENT.INVITATION_TIMEOUT,this.handleInvitationTimeout),wx.$TSignaling.off(i.EVENT.SDK_READY,this.handleSDKReady),wx.$TSignaling.off(i.EVENT.KICKED_OUT,this.handleKickedOut)}async onRemoteUserJoin(t){const{userID:e,userList:i,playerList:a}=t.data;console.log(Q,"REMOTE_USER_JOIN",t,e),this.data.playerList=a.length>0?await this.getUserProfile(a):this.data.playerList,this.data._connectUserIDList=[...this.data._connectUserIDList,e],this.data.startTalkTime||(this.data.startTalkTime=Date.now()),this.TRTCCallingDelegate.onUserEnter({userID:t.data.userID,playerList:this.data.playerList}),console.log(Q,"REMOTE_USER_JOIN","playerList:",this.data.playerList,"userList:",i)}async onRemoteUserLeave(t){const{userID:e,userList:i,playerList:a}=t.data;if(console.log(Q,"REMOTE_USER_LEAVE",t,t.data.userID),e){if(this.data.playerList=this.data.playerList.filter((t=>t.userID!==e)),a.length>0)return void this.TRTCCallingDelegate.onUserLeave({userID:e,playerList:this.data.playerList});this.lastOneHangup({userIDList:[t.data.userID],callType:this.data.config.type,callEnd:Math.round((Date.now()-this.data.startTalkTime)/1e3)}),this.data.startTalkTime=0}console.log(Q,"REMOTE_USER_LEAVE","playerList:",a,"userList:",i)}onLocalNetStateUpdate(t){const{netStatus:e}=t.data.pusher;console.log(Q,"onLocalNetStateUpdate",e),this.data.pusher=t.data.pusher,this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}async onRemoteNetStateUpdate(t){const{playerList:e}=t.data;console.log(Q,"onRemoteNetStateUpdate",e),this.data.playerList=this._updateUserProfile(this.data.playerList,e),this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}onError(t){console.log(Q,"onError",t)}onRemoteVideoAdd(t){console.log("* room REMOTE_VIDEO_ADD",t);const{player:e}=t.data;this.setPlayerAttributesHandler(e,{muteVideo:!1})}onRemoteVideoRemove(t){console.log("* room REMOTE_VIDEO_REMOVE",t);const{player:e}=t.data;this.setPlayerAttributesHandler(e,{muteVideo:!0})}async onRemoteAudioAdd(t){console.log("* room REMOTE_AUDIO_ADD",t);const e=await this.getUserProfile([t.data.player]);this.setPlayerAttributesHandler(e[0],{muteAudio:!1})}onRemoteAudioRemove(t){console.log("* room REMOTE_AUDIO_REMOVE",t);const{player:e}=t.data;this.setPlayerAttributesHandler(e,{muteAudio:!0})}async onRemoteAudioVolumeUpdate(t){console.log("* room REMOTE_AUDIO_VOLUME_UPDATE",t);const{playerList:e}=t.data;this.data.playerList=this._updateUserProfile(this.data.playerList,e),this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}onLocalAudioVolumeUpdate(t){const{pusher:e}=t.data;this.data.pusher=e,this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}_addTRTCEvent(){this.TRTC.on(this.TRTC.EVENT.REMOTE_USER_JOIN,this.onRemoteUserJoin,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_USER_LEAVE,this.onRemoteUserLeave,this),this.TRTC.on(this.TRTC.EVENT.LOCAL_NET_STATE_UPDATE,this.onLocalNetStateUpdate,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_NET_STATE_UPDATE,this.onRemoteNetStateUpdate,this),this.TRTC.on(this.TRTC.EVENT.ERROR,this.onError,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_VIDEO_ADD,this.onRemoteVideoAdd,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_VIDEO_REMOVE,this.onRemoteVideoRemove,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_AUDIO_ADD,this.onRemoteAudioAdd,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_AUDIO_REMOVE,this.onRemoteAudioRemove,this),this.TRTC.on(this.TRTC.EVENT.REMOTE_AUDIO_VOLUME_UPDATE,this.onRemoteAudioVolumeUpdate,this),this.TRTC.on(this.TRTC.EVENT.LOCAL_AUDIO_VOLUME_UPDATE,this.onLocalAudioVolumeUpdate,this)}_removeTRTCEvent(){this.TRTC.off(this.TRTC.EVENT.REMOTE_USER_JOIN,this.onRemoteUserJoin),this.TRTC.off(this.TRTC.EVENT.REMOTE_USER_LEAVE,this.onRemoteUserLeave),this.TRTC.off(this.TRTC.EVENT.LOCAL_NET_STATE_UPDATE,this.onLocalNetStateUpdate),this.TRTC.off(this.TRTC.EVENT.REMOTE_NET_STATE_UPDATE,this.onRemoteNetStateUpdate),this.TRTC.off(this.TRTC.EVENT.ERROR,this.onError),this.TRTC.off(this.TRTC.EVENT.REMOTE_VIDEO_ADD,this.onRemoteVideoAdd),this.TRTC.off(this.TRTC.EVENT.REMOTE_VIDEO_REMOVE,this.onRemoteVideoRemove),this.TRTC.off(this.TRTC.EVENT.REMOTE_AUDIO_ADD,this.onRemoteAudioAdd),this.TRTC.off(this.TRTC.EVENT.REMOTE_AUDIO_REMOVE,this.onRemoteAudioRemove),this.TRTC.off(this.TRTC.EVENT.REMOTE_AUDIO_VOLUME_UPDATE,this.onRemoteAudioVolumeUpdate),this.TRTC.off(this.TRTC.EVENT.LOCAL_AUDIO_VOLUME_UPDATE,this.onLocalAudioVolumeUpdate)}initTRTC(){const t=this.TRTC.createPusher({beautyLevel:5});this.data.pusher=t.pusherAttributes}enterRoom(t){this._addTRTCEvent();const{roomID:e}=t,i=Object.assign(this.data.config,{roomID:e,enableMic:!0,autopush:!0,enableAgc:!0,enableAns:!0,enableCamera:t.callType===d.VIDEO});this.data._unHandledInviteeList.length>0&&this._setUnHandledInviteeList(this.data.config.userID),this.data.enterRoomStatus=!0,this.data.pusher=this.TRTC.enterRoom(i),this.TRTC.getPusherInstance().start()}exitRoom(t=0,e){const{userID:i}=this.data.config;this.TRTC.getPusherInstance().stop();const a=this.TRTC.exitRoom();switch(e){case"lineBusy":this.TRTCCallingDelegate.onLineBusy({userID:i,callEnd:t});break;case"reject":this.TRTCCallingDelegate.onReject({userID:i,callEnd:t});break;default:this.TRTCCallingDelegate.onCallEnd({userID:i,callEnd:t})}this.data.pusher=a.pusher,this.data.playerList=a.playerList,this.data._unHandledInviteeList=[],this.data.enterRoomStatus=!1,this.data.isCallEnd=!0,this.initTRTC(),this._removeTRTCEvent()}setPusherAttributesHandler(t){this.data.pusher=this.TRTC.setPusherAttributes(t),this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}async setPlayerAttributesHandler(t,e){const i=this.TRTC.setPlayerAttributes(t.streamID,e);console.warn("setPlayerAttributesHandler",i),this.data.playerList=i.length>0?this._updateUserProfile(this.data.playerList,i):this.data.playerList,this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}_mutePlayerAudio(t){const e=t.currentTarget.dataset.value;e.hasAudio&&e.muteAudio?this.setPlayerAttributesHandler(e,{muteAudio:!1}):!e.hasAudio||e.muteAudio||this.setPlayerAttributesHandler(e,{muteAudio:!0})}_mutePlayerVideo(t){const e=t.currentTarget.dataset.value;e.hasVideo&&e.muteVideo?this.setPlayerAttributesHandler(e,{muteVideo:!1}):!e.hasVideo||e.muteVideo||this.setPlayerAttributesHandler(e,{muteVideo:!0})}_pusherAudioHandler(){this.data.pusher.enableMic?(this.setPusherAttributesHandler({enableMic:!1}),this.TRTC.getPusherInstance().setMICVolume({volume:0})):(this.setPusherAttributesHandler({enableMic:!0}),this.TRTC.getPusherInstance().setMICVolume({volume:100}))}_pusherVideoHandler(){this.data.pusher.enableCamera?this.setPusherAttributesHandler({enableCamera:!1}):this.setPusherAttributesHandler({enableCamera:!0})}async init(t){return Z.getInstance().getAlert().checkSync(new F({api:"init",attributes:t})),await this.login(t)}async login(t){return wx.$TSignaling.setLogLevel(0),this.data.config.userID=t.userID,this.data.config.userSig=t.userSig,new Promise(((e,i)=>{wx.$TSignaling.login({userID:t.userID,userSig:t.userSig}).then((t=>(console.log(Q,"login","IM login success",t),this._initReady=!0,this._reset(),this._addTSignalingEvent(),this.initTRTC(),this.TSignalingResolve=e,null)))}))}async logout(){this.data.callStatus!==n.CALLING&&this.data.callStatus!==n.CONNECTED||(this.data.isSponsor?await this.hangup():await this.reject()),this._reset(),wx.$TSignaling.logout({userID:this.data.config.userID,userSig:this.data.config.userSig}).then((t=>(console.log(Q,"logout","IM logout success"),this._removeTSignalingEvent(),this._removeTRTCEvent(),t))).catch((t=>{throw console.error(Q,"logout","IM logout failure"),new Error(t)}))}on(t,e,i){Z.getInstance().getAlert().checkSync(new F({api:"on",attributes:{eventCode:t,handler:e,context:i},initReady:this._initReady})),this._emitter.on(t,e,i)}off(t,e){Z.getInstance().getAlert().checkSync(new F({api:"off",attributes:{eventCode:t,handler:e}})),this._emitter.off(t,e)}async call(t){await Z.getInstance().getAlert().check(new F({api:"call",attributes:t,initReady:this._initReady,callStatus:this.data.callStatus,capabilityCode:m.BASE,checkDevicePermissions:!0}),{tim:this.tim});const{userID:e,type:i}=t,a=Math.floor(2147483646*Math.random()+1);this.enterRoom({roomID:a,callType:i});try{const s=await this.TSignalingClient.invite({roomID:a,...t});return console.log(`${Q} call(userID: ${e}, type: ${i}) success, ${s}`),this.data.config.type=i,this.data.invitation.inviteID=s.inviteID,this.data.invitation.inviter=this.data.config.userID,this.data.invitation.type=i,this.data.invitation.roomID=a,this.data.isSponsor=!0,this.data._unHandledInviteeList=[e],this._setCallStatus(n.CALLING),this._getUserProfile([e]),{data:s.data,pusher:this.data.pusher}}catch(t){console.log(`${Q} call(userID:${e},type:${i}) failed', error: ${t}`)}}async groupCall(t){try{await this.callExperimentalAPI(m.PRO)}catch(t){throw new Error(`${Q}.call - error:${JSON.stringify(t)}`)}const{type:e}=t,i=this.data.roomID||Math.floor(2147483646*Math.random()+1);this.enterRoom({roomID:i,callType:e});try{let a=[...this.data.invitation.inviteID];const s=await this.TSignalingClient.inviteGroup({roomID:i,...t});return t.groupID||0===s.code&&s.data.map((t=>(a=[...a,t.inviteID],t))),this.data.config.type=t.type,t.groupID?this.data.invitation.inviteID=s.inviteID:this.data.groupInviteID=a,this.data.invitation.inviter=this.data.config.userID,this.data.invitation.type=e,this.data.invitation.roomID=i,this.data.isSponsor=!0,this.data._isGroupCall=!0,this.data._groupID=t.groupID||"",this.data._unHandledInviteeList=[...t.userIDList],this._setCallStatus(n.CALLING),this._getUserProfile(t.userIDList),console.log(Q,"inviteInGroup OK",s),{data:s.data,pusher:this.data.pusher}}catch(t){console.log(Q,"inviteInGroup failed",t)}}async accept(){return await Z.getInstance().getAlert().check(new F({api:"accept",initReady:this._initReady,callStatus:this.data.callStatus,checkDevicePermissions:!0})),new Promise(((t,e)=>{if(console.log(Q,"accept() inviteID: ",this.data.invitation.inviteID),this.data.callStatus===n.IDLE)throw new Error("The call was cancelled");this.data.callStatus===n.CALLING&&(this.data.config.type===d.VIDEO?wx.createLivePusherContext().stopPreview({success:()=>{const i=setTimeout((async()=>{clearTimeout(i),this.handleAccept(t,e)}),0)}}):this.handleAccept(t,e))}))}async handleAccept(t,e){this.enterRoom({roomID:this.data.invitation.roomID,callType:this.data.config.type}),this._setCallStatus(n.CONNECTED);const i=await this.TSignalingClient.accept({inviteID:this.data.invitation.inviteID,type:this.data.config.type});return 0===i.code?(console.log(Q,"accept OK"),this._getGroupCallFlag()&&this._setUnHandledInviteeList(this._getUserID()),t({message:i.data.message,pusher:this.data.pusher})):(console.error(Q,"accept failed",i),e(i))}async reject(){if(Z.getInstance().getAlert().checkSync(new F({api:"reject",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.invitation.inviteID){const t=await this.TSignalingClient.reject({inviteID:this.data.invitation.inviteID,type:this.data.config.type});return 0===t.code&&(console.log(Q,"reject OK",t),this._reset()),console.log(Q,"reject failed",t),t}return console.warn(`${Q} 未收到邀请，无法拒绝`),"未收到邀请，无法拒绝"}async hangup(){Z.getInstance().getAlert().checkSync(new F({api:"hangup",callStatus:this.data.callStatus,initReady:this._initReady})),console.log(Q,"hangup.isSponsor",this.data.isSponsor);let t=null;if(this.data.isSponsor&&this.data.callStatus===n.CALLING){const e=[...this.data.groupInviteID];this.data.invitation.inviteID&&e.push(this.data.invitation.inviteID),console.log(Q,"cancel() inviteID: ",e),t=await this.TSignalingClient.cancel({inviteIDList:e,callType:this.data.invitation.type}),this.data.isCallEnd=!0}return this._reset(),t}async lastOneHangup(t){const e=this._getGroupCallFlag();await this.TSignalingClient.lastOneHangup({isGroup:e,groupID:this.data._groupID,...t}),this._reset()}_getGroupCallFlag(){return this.data._isGroupCall}_setUnHandledInviteeList(t,e){const i=[...this.data._unHandledInviteeList].filter((e=>e!==t));this.data._unHandledInviteeList=i,e&&e(i)}_getUserID(){return this.data.config.userID}_setCallStatus(t){switch(console.log("进入callStatus",t),this.data.callStatus=t,t){case n.CONNECTED:if(this.data.timer)return;this.data.timer=setInterval((()=>{this.data.chatTime=function(t){const e=t;let i,a,s,n;return e>=3600?(a=parseInt(e/3600)<10?`0${parseInt(e/3600)}`:parseInt(e/3600),s=parseInt(e%60/60)<10?`0${parseInt(e%60/60)}`:parseInt(e%60/60),n=e%3600<10?"0"+e%3600:e%3600,n>60&&(s=parseInt(n/60)<10?`0${parseInt(n/60)}`:parseInt(n/60),n=n%60<10?"0"+n%60:n%60),i=`${a}:${s}:${n}`):e>=60&&e<3600?(s=parseInt(e/60)<10?`0${parseInt(e/60)}`:parseInt(e/60),n=e%60<10?"0"+e%60:e%60,i=`00:${s}:${n}`):e<60&&(n=e<10?`0${e}`:e,i=`00:00:${n}`),i}(this.data.chatTimeNum),this.data.chatTimeNum+=1,this.data.pusher.chatTime=this.data.chatTime,this.data.pusher.chatTimeNum=this.data.chatTimeNum,this.TRTCCallingDelegate.onUserUpdate({pusher:this.data.pusher,playerList:this.data.playerList})}),1e3);break;case n.IDLE:clearInterval(this.data.timer),this.data.timer=null,this.data.chatTime="00:00:00",this.data.chatTimeNum=0}}_reset(t,e){console.log(Q," _reset()",this.data.enterRoomStatus),this.data.enterRoomStatus&&this.exitRoom(t,e),this._setCallStatus(n.IDLE),this.data.config.type=d.AUDIO,this.initData()}async startRemoteView(t){this.data.playerList.forEach((e=>{if(e.userID===t)return e.muteVideo=!1,void console.log(`${Q}, startRemoteView(${t})`)}))}stopRemoteView(t){this.data.playerList.forEach((e=>{if(e.userID===t)return e.muteVideo=!0,void console.log(`${Q}, stopRemoteView(${t})`)}))}openCamera(){Z.getInstance().getAlert().checkSync(new F({api:"openCamera",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.pusher.enableCamera||this._pusherVideoHandler(),console.log(`${Q}, openCamera() pusher: ${this.data.pusher}`)}closeCamera(){Z.getInstance().getAlert().checkSync(new F({api:"closeCamera",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.pusher.enableCamera&&this._pusherVideoHandler(),console.log(`${Q}, closeCamera() pusher: ${this.data.pusher}`)}switchCamera(){if(Z.getInstance().getAlert().checkSync(new F({api:"switchCamera",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.callStatus!==n.CONNECTED){const t="front"===this.data.pusher.frontCamera?"back":"front";this.setPusherAttributesHandler({frontCamera:t}),wx.createLivePusherContext().switchCamera()}else this.TRTC.getPusherInstance().switchCamera();console.log(`${Q}, switchCamera(), frontCamera${this.data.pusher.frontCamera}`)}openMicrophone(){Z.getInstance().getAlert().checkSync(new F({api:"openMicrophone",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.pusher.enableMic||this._pusherAudioHandler(),console.log(`${Q}, openMicrophone() pusher: ${this.data.pusher}`)}closeMicrophone(){Z.getInstance().getAlert().checkSync(new F({api:"closeMicrophone",callStatus:this.data.callStatus,initReady:this._initReady})),this.data.pusher.enableMic&&this._pusherAudioHandler(),console.log(`${Q}, closeMicrophone() pusher: ${this.data.pusher}`)}selectAudioPlaybackDevice(t){Z.getInstance().getAlert().checkSync(new F({api:"selectAudioPlaybackDevice",callStatus:this.data.callStatus,attributes:{type:t},initReady:this._initReady}));let e=!1;switch(t){case"speaker":e=!0;break;case"ear":e=!1}return this.setHandsFree(e)}setHandsFree(t){return this.data.soundMode=t?"speaker":"ear",console.log(`${Q}, setHandsFree() result: ${this.data.soundMode}`),this.data.soundMode}async switchAudioCall(){if(this._isGroupCall)console.warn(`${Q}.switchToAudioCall is not applicable to groupCall.`);else if(this.data.invitation.type!==d.AUDIO){if(this.data._switchCallModeStatus)return this.setSwitchCallModeStatus(!1),this.setPusherAttributesHandler({enableCamera:!1}),this.TSignalingClient.switchCallMode({userID:this.data._unHandledInviteeList[0]||this.data.playerList[0].userID,callType:this.data.invitation.type,roomID:this.data.invitation.roomID,mode:g});console.warn(`${Q} audio and video call switching.`)}else console.warn(`${Q} Now the call mode is audio call.`)}async switchCallMediaType(t){if(await Z.getInstance().getAlert().check(new F({api:"switchCallMediaType",attributes:{type:t},callStatus:this.data.callStatus,initReady:this._initReady})),this._isGroupCall)console.warn(`${Q}.switchToAudioCall is not applicable to groupCall.`);else if(this.data._switchCallModeStatus)switch(t){case d.AUDIO:return this.setSwitchCallModeStatus(!1),this.setPusherAttributesHandler({enableCamera:!1}),this.TSignalingClient.switchCallMode({userID:this.data._unHandledInviteeList[0]||this.data.playerList[0].userID,callType:this.data.invitation.type,roomID:this.data.invitation.roomID,mode:g});case d.VIDEO:throw console.warn(`${Q} Audio switching Video is not supported yet`),new Error(`${Q} Audio switching Video is not supported yet`)}else console.warn(`${Q} audio and video call switching.`)}setSwitchCallModeStatus(t){this.data._switchCallModeStatus=t}async switchVideoCall(){if(this._isGroupCall)console.warn(`${Q}.switchToVideoCall is not applicable to groupCall.`);else if(this.data.invitation.type!==d.VIDEO){if(this.data._switchCallModeStatus)return this.setSwitchCallModeStatus(!1),this.setPusherAttributesHandler({enableCamera:!0}),this.TSignalingClient.switchCallMode({userID:this.data.playerList[0].userID,callType:this.data.invitation.type,roomID:this.data.invitation.roomID,mode:f});console.warn(`${Q} audio and video call switching.`)}else console.warn(`${Q} Now the call mode is video call.`)}setSoundMode(t){let e=!1,i=!1;switch(t||(i=!0,t=this.data.soundMode),t){case"speaker":e=!0;break;case"ear":e=!1}return this.setHandsFree(i?!e:e)}_hangUp(){this.hangup()}_pusherStateChangeHandler(t){this.TRTC.pusherEventHandler(t)}_playerStateChange(t){this._emitter.emit(s.REMOTE_STATE_UPDATE,t)}_playerAudioVolumeNotify(t){this.data.playerList.length>0&&this.TRTC.playerAudioVolumeNotify(t)}_pusherAudioVolumeNotify(t){this.TRTC.pusherAudioVolumeNotify(t)}_updateUserProfile(t,e){if(0===e.length||0===t.length)return e;return e.map((e=>{const i=e,a=t.filter((t=>t.userID===e.userID));return i.avatar=a[0]&&a[0].avatar?a[0].avatar:"",i.nick=a[0]&&a[0].nick?a[0].nick:"",i}))}_getUserProfile(t){this.tim.getUserProfile({userIDList:t}).then((t=>{console.log("getUserProfile success",t),console.log(t.data),this.data.remoteUsers=t.data})).catch((t=>{console.warn("getUserProfile error:",t)}))}async getUserProfile(t,e="array"){if(0===t.length)return[];const i=t.map((t=>t.userID)),a=await this.tim.getUserProfile({userIDList:i});let s=null;switch(e){case"array":s=t.map(((t,e)=>(t.avatar=a.data[e].avatar,t.nick=a.data[e].nick,t)));break;case"map":s={},t.forEach(((t,e)=>{t.avatar=a.data[e].avatar,t.nick=a.data[e].nick,s[t.userID]=t}))}return s}setSelfInfo(t,e){return Z.getInstance().getAlert().checkSync(new F({api:"setSelfInfo",attributes:{nickName:t,avatar:e},initReady:this._initReady})),this.tim.updateMyProfile({nick:t,avatar:e})}_pusherNetStatus(t){this.TRTC.pusherNetStatusHandler(t)}_playNetStatus(t){this.TRTC.playerNetStatus(t)}_toggleViewSize(t){const{screen:e}=t.currentTarget.dataset;return console.log("get screen",e,t),1===this.data.playerList.length&&e!==this.data.screen&&this.data.invitation.type===d.VIDEO&&(this.data.screen=e),this.data.screen}getTim(){return this.tim}async destroyed(){this.data.callStatus!==n.CALLING&&this.data.callStatus!==n.CONNECTED||(this.data.isSponsor?this.hangup():this.reject()),this._reset(),this._removeTSignalingEvent(),this._removeTRTCEvent(),this._timExternal||await this.logout(),this._initReady=!1}async checkDevicePermissions(){return new Promise((async(t,e)=>{wx.getSetting&&wx.getSetting()||t(),wx.authorize({scope:"scope.record"}),wx.authorize({scope:"scope.camera"}),wx.getSetting().then((i=>{console.log("getSetting",i),i.authSetting["scope.camera"]&&i.authSetting["scope.record"]?t():e("camera or record not authorized")}))}))}async callExperimentalAPI(t){return new Promise((async(e,i)=>{try{const a=await this.tim.callExperimentalAPI("isCommercialAbilityEnabled",t);a.data.enabled?e(a):i("The package you purchased does not support this ability")}catch(t){2905===t.code?i("tim version is too old, Please upgrade version >= 2.20.1"):i("The package you purchased does not support this ability")}}))}}export{E as AUDIO_PLAYBACK_DEVICE,s as EVENT,d as MEDIA_TYPE,n as STATUS,tt as TUICallEngine,tt as default};
